<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weather Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; background: #1f3b73; color: #fff; text-align: center; }
.container { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin: 15px;}
.card { background:#ffffff22; padding:15px; border-radius:12px; width:130px; }
canvas { background: #ffffff11; border-radius: 10px; }
</style>
</head>

<body>
<h2>ðŸ“¡ Live Weather Dashboard â€” IST Time</h2>

<div class="container">
  <div class="card">ðŸŒ¡ Temp: <span id="temp">--</span>Â°C</div>
  <div class="card">ðŸ’§ Hum: <span id="hum">--</span>%</div>
  <div class="card">â›ˆ Pres: <span id="pres">--</span></div>
  <div class="card">ðŸ’¡ Lux: <span id="lux">--</span></div>
</div>

<canvas id="weatherChart" width="350" height="150"></canvas>

<script>
const API_URL = "https://7uxbhp38yk.execute-api.ap-south-1.amazonaws.com/v1/weather";

const tempEl = document.getElementById("temp");
const humEl = document.getElementById("hum");
const presEl = document.getElementById("pres");
const luxEl = document.getElementById("lux");

let chart;

// Convert timestamp UTC -> IST
function toIST(utcString) {
  const utc = new Date(utcString);
  return new Date(utc.getTime() + (5.5 * 60 * 60 * 1000)); // Add 5:30 hr
}

async function fetchWeather() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();

    const filtered = data
      .filter(d => d.device === "weather-node-1" && d.temperature !== null)
      .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    if (filtered.length === 0) return;

    const last = filtered[filtered.length - 1];

    tempEl.innerText = last.temperature.toFixed(1);
    humEl.innerText = last.humidity.toFixed(1);
    presEl.innerText = last.pressure.toFixed(1);
    luxEl.innerText = last.lux.toFixed(1);

    updateChart(
      filtered.map(d => toIST(d.timestamp).toLocaleTimeString("en-IN")),
      filtered.map(d => d.temperature)
    );

  } catch (e) {
    console.error("Weather fetch error:", e);
  }
}

function updateChart(labels, values) {
  const ctx = document.getElementById("weatherChart");
  if (!chart) {
    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "Temperature Â°C",
          data: values,
          borderColor: "#00ffe1",
          borderWidth: 2,
          tension: 0.3
        }]
      },
      options: {
        plugins: { legend: { labels: { color: "#fff" } } },
        scales: {
          x: { ticks: { color: "#fff"} },
          y: { ticks: { color: "#fff"} }
        }
      }
    });
  } else {
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    chart.update();
  }
}

fetchWeather();
setInterval(fetchWeather, 60000);
</script>

</body>
</html>
