<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weather Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; background: #1f3b73; color: #fff; text-align: center; }
.container { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin: 15px;}
.card { background:#ffffff22; padding:15px; border-radius:12px; width:130px; }
canvas { background: #ffffff11; border-radius: 10px; }
button {
  background:#00aaff; color:white; border:none; padding:8px 12px;
  margin:4px; border-radius:6px; cursor:pointer;
}
button:hover { background:#0099dd; }
</style>
</head>

<body>
<h2>ðŸ“¡ Live Weather Dashboard â€” IST Time</h2>

<p id="status" style="font-weight:bold; color:#ffa500;">Checking...</p>

<div style="margin-bottom:10px;">
  <button id="btnToday">Today</button>
  <button id="btn24">Last 24 Hours</button>
  <button id="btnAll">All Data</button>
</div>

<div class="container">
  <div class="card">ðŸŒ¡ Temp: <span id="temp">--</span>Â°C</div>
  <div class="card">ðŸ’§ Hum: <span id="hum">--</span>%</div>
  <div class="card">â›ˆ Pres: <span id="pres">--</span></div>
  <div class="card">ðŸ’¡ Lux: <span id="lux">--</span></div>
</div>

<canvas id="weatherChart" width="350" height="150"></canvas>

<script>
const API_URL = "https://7uxbhp38yk.execute-api.ap-south-1.amazonaws.com/v1/weather";

const tempEl = document.getElementById("temp");
const humEl = document.getElementById("hum");
const presEl = document.getElementById("pres");
const luxEl = document.getElementById("lux");
const statusEl = document.getElementById("status");

let chart;
let allData = [];

// ---------- Helpers for time handling ----------

// gap in minutes between now (UTC) and given Date
function timeGapMinutes(t){ return (Date.now() - t.getTime()) / 60000; }
// gap in hours between now (UTC) and given Date
function timeGapHours(t){ return (Date.now() - t.getTime()) / 3600000; }

// convert a UTC Date to IST date parts (Y-M-D)
function toISTDateParts(dateUtc) {
  const ist = new Date(dateUtc.getTime() + 5.5 * 3600 * 1000);
  return {
    y: ist.getUTCFullYear(),
    m: ist.getUTCMonth(),
    d: ist.getUTCDate()
  };
}

function isSameISTDay(d1, d2) {
  const a = toISTDateParts(d1);
  const b = toISTDateParts(d2);
  return a.y === b.y && a.m === b.m && a.d === b.d;
}

// ---------- Fetch + view update ----------

async function fetchWeather() {
  try {
    const res = await fetch(API_URL);
    allData = await res.json();
    updateView("all");
  } catch (e) {
    console.error("âŒ Error fetching:", e);
    showNoData();
  }
}

function updateView(viewType) {
  let filtered = allData.filter(d =>
    d.device === "weather-node-1" && d.temperature !== null
  );

  // keep timestamps as proper Date objects (UTC internally)
  filtered = filtered.map(d => ({
    ...d,
    ts: new Date(d.timestamp) // this parses "2025-12-05T16:46:22Z" as UTC
  })).sort((a,b)=> a.ts - b.ts);

  const latest = filtered[filtered.length - 1];

  if (!latest || timeGapMinutes(latest.ts) > 10) {
    showNoData();
    return;
  }

  statusEl.innerText = "Live âœ”";
  statusEl.style.color = "#00ff88";

  tempEl.innerText = latest.temperature.toFixed(1);
  humEl.innerText = latest.humidity.toFixed(1);
  presEl.innerText = latest.pressure.toFixed(1);
  luxEl.innerText = latest.lux.toFixed(1);

  // filters
  if (viewType === "today") {
    const nowUtc = new Date();
    filtered = filtered.filter(d => isSameISTDay(d.ts, nowUtc));
  }

  if (viewType === "24h") {
    filtered = filtered.filter(d => timeGapHours(d.ts) <= 24);
  }

  // labels in IST using toLocaleString with explicit timeZone
  const labels = filtered.map(d =>
    d.ts.toLocaleString("en-IN", {
      timeZone: "Asia/Kolkata",
      hour12: true,
      hour: "2-digit",
      minute: "2-digit",
      day: "2-digit",
      month: "short"
    })
  );

  const temps = filtered.map(d => d.temperature);

  drawChart(labels, temps);
}

function showNoData() {
  statusEl.innerText = "âš  No Data Received";
  statusEl.style.color = "yellow";
  tempEl.innerText = humEl.innerText = presEl.innerText = luxEl.innerText = "0";
  drawChart([], []);
}

// ---------- Chart ----------

function drawChart(labels, values) {
  const ctx = document.getElementById("weatherChart");
  if (!chart) {
    chart = new Chart(ctx,{
      type:"line",
      data:{ labels, datasets:[{
        label:"Temp Â°C", data:values,
        borderWidth:2, borderColor:"#00ffe1",
        tension:0.3
      }]},
      options:{
        plugins:{ legend:{ labels:{ color:"#fff" }}},
        scales:{
          x:{ ticks:{ color:"#fff" }},
          y:{ ticks:{ color:"#fff" }}
        }
      }
    });
  } else {
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    chart.update();
  }
}

// ---------- Buttons + auto refresh ----------

document.getElementById("btnToday").onclick = ()=>updateView("today");
document.getElementById("btn24").onclick = ()=>updateView("24h");
document.getElementById("btnAll").onclick = ()=>updateView("all");

fetchWeather();
setInterval(fetchWeather,60000);
</script>

</body>
</html>
