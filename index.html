<script>
const API_URL = "https://7uxbhp38yk.execute-api.ap-south-1.amazonaws.com/v1/weather";

const tempEl = document.getElementById("temp");
const humEl = document.getElementById("hum");
const presEl = document.getElementById("pres");
const luxEl = document.getElementById("lux");

let chart;

async function fetchWeather() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();

    const filtered = data.filter(d => d.device === "weather-node-1" && d.temperature !== null);
    const last = filtered[filtered.length - 1];

    tempEl.innerText = last.temperature.toFixed(1);
    humEl.innerText = last.humidity.toFixed(1);
    presEl.innerText = last.pressure.toFixed(1);
    luxEl.innerText = last.lux.toFixed(1);

    updateChart(
      filtered.map(d => d.timestamp),
      filtered.map(d => d.temperature)
    );
  } catch (e) {
    console.error("Weather fetch error:", e);
  }
}

function updateChart(labels, values) {
  const ctx = document.getElementById("weatherChart");
  if (!chart) {
    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "Temperature Â°C",
          data: values,
          borderColor: "#00ffe1",
          borderWidth: 2,
          tension: 0.3
        }]
      },
      options: {
        plugins: { legend: { labels: { color: "#fff" } } },
        scales: {
          x: { ticks: { color: "#fff" } },
          y: { ticks: { color: "#fff" } }
        }
      }
    });
  } else {
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    chart.update();
  }
}

fetchWeather();
setInterval(fetchWeather, 60000);
</script>
