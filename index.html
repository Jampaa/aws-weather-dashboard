<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weather Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; background: #1f3b73; color: #fff; text-align: center; }
.container { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin: 15px;}
.card { background:#ffffff22; padding:15px; border-radius:12px; width:130px; }
canvas { background: #ffffff11; border-radius: 10px; margin: 10px 0; }
button {
  background:#00aaff; color:white; border:none; padding:8px 12px;
  margin:4px; border-radius:6px; cursor:pointer;
}
button:hover { background:#0099dd; }
button.active { background:#00ff88; }
</style>
</head>

<body>
<h2>ðŸ“¡ Live Weather Dashboard â€” IST Time</h2>

<p id="status" style="font-weight:bold; color:#ffa500;">Checking...</p>

<div style="margin-bottom:10px;">
  <button id="btnToday">Today</button>
  <button id="btn24">Last 24 Hours</button>
  <button id="btnAll">All Data</button>
</div>

<div class="container">
  <div class="card">ðŸŒ¡ Temp: <span id="temp">--</span>Â°C</div>
  <div class="card">ðŸ’§ Hum: <span id="hum">--</span>%</div>
  <div class="card">â›ˆ Pres: <span id="pres">--</span></div>
  <div class="card">ðŸ’¡ Lux: <span id="lux">--</span></div>
</div>

<!-- Temperature Chart -->
<h3 style="margin: 20px 0 5px 0;">Temperature</h3>
<canvas id="tempChart" width="350" height="150"></canvas>

<!-- Lux Chart -->
<h3 style="margin: 20px 0 5px 0;">Lux (Light)</h3>
<canvas id="luxChart" width="350" height="150"></canvas>

<script>
const API_URL = "https://7uxbhp38yk.execute-api.ap-south-1.amazonaws.com/v1/weather";

const tempEl = document.getElementById("temp");
const humEl = document.getElementById("hum");
const presEl = document.getElementById("pres");
const luxEl = document.getElementById("lux");
const statusEl = document.getElementById("status");

let tempChart, luxChart;
let allData = [];

// ---------- Helpers for time handling ----------

function timeGapMinutes(t){ return (Date.now() - t.getTime()) / 60000; }
function timeGapHours(t){ return (Date.now() - t.getTime()) / 3600000; }

function formatTimeGap(minutes) {
  if (minutes < 60) return `${Math.round(minutes)} min ago`;
  if (minutes < 1440) return `${Math.round(minutes/60)} hrs ago`;
  return `${Math.round(minutes/1440)} days ago`;
}

function toISTDateParts(dateUtc) {
  const ist = new Date(dateUtc.getTime() + 5.5 * 3600 * 1000);
  return {
    y: ist.getUTCFullYear(),
    m: ist.getUTCMonth(),
    d: ist.getUTCDate()
  };
}

function isSameISTDay(d1, d2) {
  const a = toISTDateParts(d1);
  const b = toISTDateParts(d2);
  return a.y === b.y && a.m === b.m && a.d === b.d;
}

// ---------- Fetch + view update ----------

async function fetchWeather() {
  try {
    const res = await fetch(API_URL);
    allData = await res.json();
    updateView("all");
  } catch (e) {
    console.error("âŒ Error fetching:", e);
    statusEl.innerText = "âŒ API Error";
    statusEl.style.color = "#ff4444";
  }
}

function updateView(viewType) {
  let filtered = allData.filter(d =>
    d.device === "weather-node-1" && d.temperature !== null
  );

  filtered = filtered.map(d => ({
    ...d,
    ts: new Date(d.timestamp)
  })).sort((a,b)=> a.ts - b.ts);

  const latest = filtered[filtered.length - 1];

  if (!latest) {
    statusEl.innerText = "âš  No valid data";
    statusEl.style.color = "yellow";
    tempEl.innerText = humEl.innerText = presEl.innerText = luxEl.innerText = "0";
    updateCharts([], []);
    return;
  }

  // Show live status OR time since last update
  const gap = timeGapMinutes(latest.ts);
  if (gap <= 10) {
    statusEl.innerText = "Live âœ”";
    statusEl.style.color = "#00ff88";
  } else {
    statusEl.innerText = `Last update: ${formatTimeGap(gap)}`;
    statusEl.style.color = "#ffa500";
  }

  // Always show latest readings
  tempEl.innerText = latest.temperature.toFixed(1);
  humEl.innerText = latest.humidity ? latest.humidity.toFixed(1) : "N/A";
  presEl.innerText = latest.pressure ? latest.pressure.toFixed(1) : "N/A";
  luxEl.innerText = latest.lux ? latest.lux.toFixed(1) : "N/A";

  // Apply filters
  let chartData = filtered;
  if (viewType === "today") {
    const nowUtc = new Date();
    chartData = filtered.filter(d => isSameISTDay(d.ts, nowUtc));
  } else if (viewType === "24h") {
    chartData = filtered.filter(d => timeGapHours(d.ts) <= 24);
  }

  const labels = chartData.map(d =>
    d.ts.toLocaleString("en-IN", {
      timeZone: "Asia/Kolkata",
      hour12: true,
      hour: "2-digit",
      minute: "2-digit",
      day: "2-digit",
      month: "short"
    })
  );

  updateCharts(labels, chartData);
}

function updateCharts(labels, data) {
  const temps = data.map(d => d.temperature);
  const luxes = data.map(d => d.lux || 0);

  // Update Temp Chart
  if (tempChart) {
    tempChart.data.labels = labels;
    tempChart.data.datasets[0].data = temps;
    tempChart.update();
  } else {
    const ctxTemp = document.getElementById("tempChart");
    tempChart = new Chart(ctxTemp, {
      type: "line",
      data: { labels, datasets: [{
        label: "Temp Â°C", data: temps,
        borderWidth: 2, borderColor: "#00ffe1",
        backgroundColor: "#00ffe133",
        tension: 0.3, fill: true
      }]},
      options: {
        plugins: { legend: { labels: { color: "#fff" }}},
        scales: {
          x: { ticks: { color: "#fff", maxRotation: 45 }},
          y: { ticks: { color: "#fff" }}
        }
      }
    });
  }

  // Update Lux Chart
  if (luxChart) {
    luxChart.data.labels = labels;
    luxChart.data.datasets[0].data = luxes;
    luxChart.update();
  } else {
    const ctxLux = document.getElementById("luxChart");
    luxChart = new Chart(ctxLux, {
      type: "line",
      data: { labels, datasets: [{
        label: "Lux", data: luxes,
        borderWidth: 2, borderColor: "#ffaa00",
        backgroundColor: "#ffaa0033",
        tension: 0.3, fill: true
      }]},
      options: {
        plugins: { legend: { labels: { color: "#fff" }}},
        scales: {
          x: { ticks: { color: "#fff", maxRotation: 45 }},
          y: { ticks: { color: "#fff" }}
        }
      }
    });
  }
}

// ---------- Buttons + auto refresh ----------

function setActiveButton(id) {
  document.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

document.getElementById("btnToday").onclick = () => { updateView("today"); setActiveButton("btnToday"); };
document.getElementById("btn24").onclick = () => { updateView("24h"); setActiveButton("btn24"); };
document.getElementById("btnAll").onclick = () => { updateView("all"); setActiveButton("btnAll"); };

fetchWeather();
setInterval(fetchWeather, 60000);
</script>

</body>
</html>
